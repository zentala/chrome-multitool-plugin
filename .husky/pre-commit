#!/bin/sh
. "$(dirname -- "$0")/_/husky.sh"

# Allow skipping hooks with --no-verify flag
if git rev-parse --verify HEAD >/dev/null 2>&1; then
    against=HEAD
else
    against=$(git hash-object -t tree /dev/null)
fi

# Skip pre-commit hooks if --no-verify is used
if git diff --cached --quiet --exit-code; then
    exit 0
fi

# Check for skip flag in commit message
SKIP_HOOKS=$(git log -1 --oneline -n 1 2>/dev/null | grep -o "\[skip ci\]" || echo "")

if [ "$SKIP_HOOKS" = "[skip ci]" ]; then
    echo "â­ï¸  Skipping pre-commit checks due to [skip ci] in commit message"
    exit 0
fi

echo "ğŸ” Running pre-commit checks..."

# Run tests
echo "ğŸ§ª Running tests..."
if pnpm run test; then
    echo "âœ… Tests passed"
else
    echo "âŒ Tests failed"
    echo "ğŸ’¡ To skip checks, add [skip ci] to your commit message"
    exit 1
fi

# Run linting
echo "ğŸ” Running linter..."
if pnpm run lint; then
    echo "âœ… Linting passed"
else
    echo "âŒ Linting failed"
    echo "ğŸ’¡ To skip checks, add [skip ci] to your commit message"
    exit 1
fi

echo "ğŸ‰ All checks passed!"
